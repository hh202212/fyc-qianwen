<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>新人收入目标测算看板</title>
    <script src="https://fastly.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #e60012; --gray: #f4f4f4; --border: #ddd; --gold: #d4a017; --tip-bg: #fffbe6; --secondary: #1890ff; --danger: #ff4d4f; }
        body { font-family: "PingFang SC", "Microsoft YaHei"; background: #fafafa; margin: 0; padding: 8px; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .watermark-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0.12; background-repeat: repeat; }

        .header-area { border-bottom: 2px solid var(--primary); margin-bottom: 10px; padding-bottom: 10px; display: flex; flex-direction: column; gap: 8px; position: relative; z-index: 20; }
        .main-title { font-size: 18px; font-weight: bold; color: #333; margin: 0; }
        .sub-title { font-size: 11px; color: #999; }

        .top-nav-container { margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 5px; position: relative; z-index: 20; }
        .btn-link { color: #856404; background: var(--tip-bg); border: 1px solid #ffe58f; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; text-decoration: none; display: inline-flex; align-items: center; }
        
        .rule-body { display: none; background: var(--tip-bg); border: 1px solid #ffe58f; border-top: none; padding: 10px; border-radius: 0 0 4px 4px; margin-top: -8px; margin-bottom: 12px; position: relative; z-index: 19; }
        .rule-col { font-size: 11px; color: #856404; line-height: 1.5; }

        /* 输入面板自适应 */
        .input-panel { display: flex; flex-wrap: wrap; gap: 8px; background: var(--gray); padding: 12px; border-radius: 6px; margin-bottom: 15px; position: relative; z-index: 20; }
        .input-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 45%; }
        @media (max-width: 400px) { .input-group { min-width: 100%; } }
        
        .input-group label { font-size: 11px; font-weight: bold; color: #444; }
        input, select { height: 36px; padding: 0 8px; border: 1px solid var(--border); border-radius: 4px; background: #fff; font-size: 13px; width: 100%; outline: none; }

        #referralInputs { width: 100%; display: none; flex-wrap: wrap; gap: 8px; margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 8px; }
        .ref-item { flex: 1; min-width: 45%; display: flex; flex-direction: column; gap: 4px; }

        /* 福利快捷区美化 */
        .history-tags { width: 100%; display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .history-tag { 
            background: #fff; border: 1px solid #d9d9d9; padding: 4px 10px; border-radius: 15px; 
            font-size: 12px; cursor: pointer; color: #555; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .history-tag:active { background: #f0f0f0; }
        .tag-name { max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .tag-close { color: #999; font-size: 14px; padding: 0 2px; }
        .tag-close:hover { color: var(--danger); }

        .btn-calc { background: var(--primary); color: #fff; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; width: 100%; margin-top: 8px; }

        /* 表格自适应优化 */
        .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 4px; position: relative; z-index: 15; background: #fff; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .compare-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .compare-table th, .compare-table td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 8px 5px; text-align: center; white-space: nowrap; }
        
        .label-col { width: 95px; min-width: 95px !important; background: #f9f9f9 !important; text-align: left !important; font-weight: bold; font-size: 12px; position: sticky; left: 0; z-index: 5; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        
        /* 方案标题容器：确保显示“方案1” */
        .scheme-header { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; min-width: 75px; }
        .scheme-title { font-size: 13px; font-weight: bold; color: var(--primary); }
        @media (max-width: 480px) { .scheme-title { font-size: 11px; } } /* 屏幕过窄时自动缩小字体 */

        .cat-row { background: #fff1f0 !important; font-weight: bold; color: var(--primary); font-size: 12px; }
        .total-val { font-size: 15px; font-weight: 800; color: var(--primary); }
        .is-winner .total-val { color: var(--gold); }

        @media print {
            .input-panel, .del-btn, .rule-btn, .top-nav-container a, .header-area div button { display: none !important; }
            .label-col { position: static !important; }
        }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <div class="watermark-overlay" id="watermark"></div>

    <div class="header-area">
        <p class="main-title">新人收入目标测算看板</p>
        <div style="display: flex; gap: 5px;">
            <button onclick="clearAllData()" style="flex:1; background:var(--danger); border:none; color:#fff; border-radius:4px; padding:5px 10px; font-size:11px;">清空</button>
            <button onclick="exportExcel()" style="flex:1; background:#52c41a; border:none; color:#fff; border-radius:4px; padding:5px 10px; font-size:11px;">导出</button>
            <button onclick="smartPrint()" style="flex:1; background:var(--secondary); border:none; color:#fff; border-radius:4px; padding:5px 10px; font-size:11px;">打印</button>
        </div>
    </div>

    <div class="top-nav-container">
        <div class="btn-link rule-btn" onclick="toggleRule()">训练津贴规则原文</div>
        <a href="https://free-img.400040.xyz/4/2026/02/01/697f049d026fe.jpg" target="_blank" class="btn-link">首次钻方案</a>
        <a href="https://free-img.400040.xyz/4/2026/02/01/697f049ece8ab.jpg" target="_blank" class="btn-link">一桌宴方案</a>
    </div>

    <div class="rule-body" id="ruleBody">
        <div class="rule-col">
            <strong>1-12期：</strong> 参会率≥75%；飞鹰、新锐、新人集训合格；第4月起需转正。<br>
            <strong>13-18期：</strong> 参会率≥75%；继续率≥80%。
        </div>
    </div>

    <div class="input-panel">
        <div class="input-group"><label>人员职级</label><select id="rank"><option value="P0">P0</option><option value="P1">P1</option><option value="P2">P2</option><option value="P3">P3</option><option value="P4">P4</option><option value="P5">P5</option><option value="P6">P6</option><option value="P7">P7</option><option value="P8">P8</option><option value="P9">P9</option></select></div>
        <div class="input-group"><label>标签</label><select id="tag" onchange="initPeriodOptions()"><option value="优++">优++</option><option value="优+" selected>优+</option><option value="FNA">FNA</option><option value="NA">NA</option></select></div>
        <div class="input-group"><label>期数</label><select id="period"></select></div>
        <div class="input-group"><label>个人FYC</label><input type="number" id="fyc" value="3000"></div>
        <div class="input-group"><label>是否有增员？</label><select id="hasReferral" onchange="updateReferralInputs()"><option value="否">否</option><option value="是">是</option></select></div>
        
        <div id="referralInputs">
            <div class="ref-item"><label>推荐月数</label><select id="referralMonths"><option value="1-12">1-12月</option><option value="13-24">13-24月</option></select></div>
            <div class="ref-item"><label>推荐FYC</label><input type="number" id="referralFycInput" value="3000"></div>
            <div class="ref-item"><label>继续率</label><select id="referralContinuation"><option value="80%以下">80%以下</option><option value="80%以上" selected>80%及以上</option></select></div>
        </div>
        
        <div style="width: 100%; border-top: 1px dashed #ccc; margin-top: 5px; padding-top: 8px;">
            <div style="display: flex; gap: 5px;">
                <input type="text" id="customName" placeholder="福利名称" style="flex:2;">
                <input type="number" id="customAmount" placeholder="价值" style="flex:1;">
                <button onclick="addCustomItem()" style="background:var(--secondary); color:#fff; border:none; border-radius:4px; padding:0 12px; font-weight:bold;">＋</button>
            </div>
            <div class="history-tags" id="historyTags"></div> </div>
        <button class="btn-calc" onclick="addScheme()">生成方案并对比</button>
    </div>

    <div class="table-wrapper">
        <table class="compare-table" id="resTable">
            <thead><tr class="header-row" id="hRow"><th class="label-col">测算维度</th></tr></thead>
            <tbody id="bBody">
                <tr class="cat-row"><td class="label-col">基本信息</td></tr>
                <tr data-k="rank"><td class="label-col">测算职级</td></tr>
                <tr data-k="tag"><td class="label-col">标签/期数</td></tr>
                <tr class="cat-row"><td class="label-col">收益项目</td></tr>
                <tr data-k="fyc"><td class="label-col">佣金 (FYC)</td></tr>
                <tr data-k="sales"><td class="label-col">销售津贴</td></tr>
                <tr data-k="subsidy"><td class="label-col">训津 (实发)</td></tr>
                <tr data-k="defer"><td class="label-col">训津递延</td></tr>
                <tr data-k="ref_total"><td class="label-col">增员奖</td></tr>
                <tr class="cat-row"><td class="label-col">其他福利</td></tr>
                <tr class="total-row" data-k="total" style="background:#fff9f9"><td class="label-col">预计总利益</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let currentCustomItems = [], schemes = [], welfareHistory = [], sIdx = 1;

    function saveData() { 
        localStorage.setItem('fyc_v8', JSON.stringify(schemes)); 
        localStorage.setItem('fyc_idx_v8', sIdx); 
        localStorage.setItem('fyc_wHist_v8', JSON.stringify(welfareHistory)); 
    }
    function loadData() {
        const saved = localStorage.getItem('fyc_v8'), savedH = localStorage.getItem('fyc_wHist_v8');
        if (saved) { schemes = JSON.parse(saved); sIdx = parseInt(localStorage.getItem('fyc_idx_v8')) || 1; rebuildTable(); }
        if (savedH) { welfareHistory = JSON.parse(savedH); renderHistoryTags(); }
    }
    function clearAllData() { if(confirm("清空全部记录？")) { localStorage.clear(); location.reload(); } }

    function rebuildTable() {
        const hRow = document.getElementById('hRow'), bBody = document.getElementById('bBody');
        while (hRow.cells.length > 1) hRow.deleteCell(1);
        Array.from(bBody.rows).forEach(row => { while (row.cells.length > 1) row.deleteCell(1); });
        Array.from(bBody.querySelectorAll('tr[data-custom-row]')).forEach(r => r.remove());

        const allNames = [...new Set(schemes.flatMap(s => s.customItems.map(i => i.name)))];
        const otherCat = Array.from(bBody.rows).find(r => r.innerText.includes('其他福利'));
        allNames.forEach(name => {
            const tr = document.createElement('tr'); tr.setAttribute('data-custom-row', name);
            tr.innerHTML = `<td class="label-col">${name}</td>`; otherCat.after(tr);
        });

        schemes.forEach(s => {
            const th = document.createElement('th');
            // 修改点：确保显示完整“方案1”，且支持移除功能
            th.innerHTML = `
                <div class="scheme-header">
                    <span class="scheme-title">方案${s.displayIdx}</span>
                    <span onclick="removeCol('${s.id}')" style="font-size:10px; color:#999; text-decoration:underline;">移除</span>
                </div>`;
            hRow.appendChild(th);

            Array.from(bBody.rows).forEach(row => {
                const k = row.getAttribute('data-k'), cName = row.getAttribute('data-custom-row'), td = document.createElement('td');
                td.className = s.id + '-c' + (k==='total'?' win-cell':'');
                if(k) td.innerHTML = s.dataMap[k] || '—';
                else if(cName) { 
                    const match = s.customItems.find(i => i.name === cName); 
                    td.innerHTML = match ? `¥${match.amount.toLocaleString()}` : '—'; 
                }
                row.appendChild(td);
            });
        });
        updateWin();
    }

    function addCustomItem() {
        const name = document.getElementById('customName').value.trim(), amount = parseFloat(document.getElementById('customAmount').value);
        if (name && !isNaN(amount)) {
            currentCustomItems.push({ name, amount });
            if (!welfareHistory.includes(name)) welfareHistory.push(name);
            document.getElementById('customName').value = ''; document.getElementById('customAmount').value = '';
            renderHistoryTags();
            alert("已暂存该福利，生成方案后即可查看");
        }
    }

    // 修改点：福利历史标签添加关闭按钮
    function renderHistoryTags() {
        document.getElementById('historyTags').innerHTML = welfareHistory.map((name, index) => `
            <div class="history-tag">
                <span class="tag-name" onclick="document.getElementById('customName').value='${name}'">${name}</span>
                <span class="tag-close" onclick="removeHistoryItem(${index})">×</span>
            </div>
        `).join('');
    }

    function removeHistoryItem(index) {
        event.stopPropagation();
        welfareHistory.splice(index, 1);
        renderHistoryTags();
        saveData();
    }

    const salesMatrix = { 'P0':[0,0,0,0,0,0,0,0],'P1':[0,0,0,0,0,0,0,0],'P2':[0,0.04,0.09,0.13,0.13,0.13,0.13,0.13],'P3':[0,0.06,0.11,0.15,0.18,0.18,0.18,0.18],'P4':[0,0.06,0.25,0.30,0.35,0.35,0.35,0.35],'P5':[0,0.06,0.27,0.32,0.37,0.42,0.42,0.42],'P6':[0,0.06,0.30,0.34,0.40,0.45,0.47,0.47],'P7':[0,0.06,0.32,0.37,0.42,0.50,0.52,0.55],'P8':[0,0.06,0.32,0.37,0.45,0.52,0.55,0.57],'P9':[0,0.06,0.32,0.37,0.45,0.55,0.57,0.60] };
    function getSubsidy(f, t, p) { let val=0, def=0; if(t==='优++') { let i=[3000,6000,10000,20000,30000,60000].findIndex(v=>f<v); i=i===-1?5:Math.max(0,i-1); if(f>=3000){ val=(p==='13-18')?[1800,5400,8000,16000,20000,30000][i]:[3600,6000,10000,20000,30000,60000][i]; def=f>=10000?[0,0,0.3,0.4,0.5,0.6][i]:0; } } else { let i=[600,1500,3000,6000,10000,20000,30000].findIndex(v=>f<v); i=i===-1?6:Math.max(0,i-1); if(p==='1-3') val=t==='优+'?[1000,2400,3600,4400,5400,8500,11500][i]:(t==='FNA'?[1000,1800,2400,3000,3800,6000,8000][i]:[600,1100,1400,1400,1400,1400,1400][i]); else if(p==='4-12'&&t!=='NA') val=t==='优+'?[1000,1600,2700,4400,5400,8500,11500][i]:[1000,1300,1800,2400,3300,5500,7500][i]; else if(p==='13-18'&&t==='优+') val=[0,0,1400,2700,3600,5800,8100][i]; } return { cash: val*(1-def), defer: val*def }; }

    function addScheme() {
        const f = parseFloat(document.getElementById('fyc').value)||0, r = document.getElementById('rank').value, t = document.getElementById('tag').value, p = document.getElementById('period').value;
        const rates = salesMatrix[r]||salesMatrix['P0'], rate = f<1500?rates[0]:f<3000?rates[1]:f<6000?rates[2]:f<10000?rates[3]:f<20000?rates[4]:f<30000?rates[5]:f<60000?rates[6]:rates[7];
        const sales = f * rate, sub = getSubsidy(f, t, p);
        let ref = 0; if(document.getElementById('hasReferral').value==='是'){ 
            const rf=parseFloat(document.getElementById('referralFycInput').value)||0, rm=document.getElementById('referralMonths').value, rc=document.getElementById('referralContinuation').value;
            const c1=(rm==='1-12')?(rf<1500?0.05:rf<3000?0.15:rf<6000?0.21:0.24):(rf>=6000?0.1:rf>=3000?0.08:0);
            ref=rf*c1*((rm==='13-24'&&rc==='80%以下')?0:1);
        }
        const total = f+sales+sub.cash+sub.defer+ref+currentCustomItems.reduce((s,i)=>s+i.amount, 0);
        const dataMap = { rank:r, tag:`${t}(${p})`, fyc:`¥${f.toLocaleString()}`, sales:`¥${sales.toLocaleString()}`, subsidy:`¥${sub.cash.toLocaleString()}`, defer:`¥${sub.defer.toLocaleString()}`, ref_total:`¥${ref.toLocaleString()}`, total:`¥${total.toLocaleString()}` };
        schemes.push({ id:'s'+Date.now(), total, displayIdx: sIdx++, customItems: [...currentCustomItems], dataMap });
        saveData(); rebuildTable(); currentCustomItems = [];
    }

    function removeCol(id) { schemes = schemes.filter(x => x.id !== id); saveData(); rebuildTable(); }
    function updateWin() { if(!schemes.length) return; const max = Math.max(...schemes.map(s => s.total)); schemes.forEach(s => { const el = document.querySelector('.' + s.id + '-c.win-cell'); if (el) el.classList.toggle('is-winner', s.total === max && max > 0); }); }
    function toggleRule() { const b = document.getElementById('ruleBody'); b.style.display = (b.style.display==='block'?'none':'block'); }
    function initPeriodOptions() { const t = document.getElementById('tag').value, p = document.getElementById('period'); p.innerHTML = ''; let opts = t==='优++' ? [['4-12期','4-12'],['13-18期','13-18']] : [['1-3期','1-3'],['4-12期','4-12'],['13-18期','13-18']]; opts.forEach(o => p.add(new Option(o[0], o[1]))); }
    function updateReferralInputs() { document.getElementById('referralInputs').style.display = (document.getElementById('hasReferral').value==='是'?'flex':'none'); }
    function smartPrint() { const t = document.getElementById('resTable'); document.body.style.zoom = (t.offsetWidth > 1000) ? (1000 / t.offsetWidth).toFixed(2) : 1; window.print(); setTimeout(()=>document.body.style.zoom=1,500); }
    function exportExcel() { const t = document.getElementById('resTable').cloneNode(true); t.querySelectorAll('.del-btn, .crown-icon').forEach(e => e.remove()); XLSX.writeFile(XLSX.utils.table_to_book(t), '新人报告.xlsx'); }
    window.onload = () => { initPeriodOptions(); loadData(); const c = document.createElement('canvas'); c.width=200; c.height=150; const ctx = c.getContext('2d'); ctx.rotate(-0.4); ctx.font='14px Arial'; ctx.fillStyle='rgba(0,0,0,0.1)'; ctx.fillText('PA福小昊', 20, 80); document.getElementById('watermark').style.backgroundImage = `url(${c.toDataURL()})`; }
</script>
</body>
</html>
