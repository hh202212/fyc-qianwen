<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°äººæ”¶å…¥ç›®æ ‡æµ‹ç®—çœ‹æ¿</title>
    <script src="https://fastly.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #e60012; --gray: #f4f4f4; --border: #ddd; --gold: #d4a017; --tip-bg: #fffbe6; --secondary: #1890ff; --danger: #ff4d4f; }
        body { font-family: "PingFang SC", "Microsoft YaHei"; background: #fafafa; margin: 0; padding: 10px; -webkit-tap-highlight-color: transparent; }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

        .container { max-width: 1400px; margin: 0 auto; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .watermark-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0.12; background-repeat: repeat; }

        .header-area { border-bottom: 2px solid var(--primary); margin-bottom: 10px; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 20; flex-wrap: wrap; gap: 10px; }
        .main-title { font-size: 20px; font-weight: bold; color: #333; margin: 0; }
        .sub-title { font-size: 12px; color: #999; width: 100%; }

        /* å¯¼èˆªç»„è‡ªé€‚åº” */
        .top-nav-container { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 6px; position: relative; z-index: 20; }
        .btn-link { color: #856404; background: var(--tip-bg); border: 1px solid #ffe58f; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; text-decoration: none; display: inline-flex; align-items: center; }
        
        .rule-body { display: none; background: var(--tip-bg); border: 1px solid #ffe58f; border-top: none; padding: 12px; border-radius: 0 0 4px 4px; margin-top: -8px; margin-bottom: 15px; position: relative; z-index: 19; }
        .rule-columns { display: flex; gap: 20px; flex-wrap: wrap; }
        .rule-col { flex: 1; min-width: 260px; font-size: 12px; color: #856404; line-height: 1.6; }

        /* è¾“å…¥é¢æ¿ï¼šæ‰‹æœºç«¯è‡ªåŠ¨åˆ‡æ¢ä¸ºåˆ—å¸ƒå±€ */
        .input-panel { display: flex; flex-wrap: wrap; gap: 10px; background: var(--gray); padding: 15px; border-radius: 6px; margin-bottom: 20px; position: relative; z-index: 20; align-items: flex-end; }
        .input-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 45%; } /* æ‰‹æœºç«¯æ¯è¡Œä¸¤ä¸ª */
        @media (max-width: 600px) { .input-group { min-width: 100%; } } /* è¶…çª„å±å•åˆ— */
        
        .input-group label { font-size: 12px; font-weight: bold; color: #444; }
        input, select { height: 40px; padding: 0 10px; border: 1px solid var(--border); border-radius: 4px; background: #fff; font-size: 14px; width: 100%; outline: none; }

        /* å¢å‘˜é¡¹æ‰‹æœºç«¯å¯¹é½ */
        #referralInputs { width: 100%; display: none; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .ref-item { flex: 1; min-width: 45%; display: flex; flex-direction: column; gap: 5px; }
        @media (max-width: 600px) { .ref-item { min-width: 100%; } }

        .btn-calc { background: var(--primary); color: #fff; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s; width: 100%; margin-top: 10px; }

        /* è¡¨æ ¼åŒºï¼šé¦–åˆ—é”å®šï¼ˆæ ¸å¿ƒé€‚é…ï¼‰ */
        .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 4px; position: relative; z-index: 15; background: #fff; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .compare-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .compare-table th, .compare-table td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 10px 8px; text-align: center; font-size: 13px; white-space: nowrap; }
        
        /* æ‰‹æœºç«¯é¦–åˆ—å›ºå®š */
        .label-col { width: 120px; min-width: 120px !important; background: #f9f9f9 !important; text-align: left !important; font-weight: bold; position: sticky; left: 0; z-index: 5; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }

        .header-row th { background: #fff; position: sticky; top: 0; z-index: 6; color: var(--primary); border-bottom: 2px solid var(--primary); }
        .cat-row { background: #fff1f0 !important; font-weight: bold; color: var(--primary); }
        
        .total-val { font-size: 16px; font-weight: 800; color: var(--primary); }
        .crown-icon { display: none; font-size: 16px; }
        .is-winner .total-val { color: var(--gold); }
        .is-winner .crown-icon { display: block; }

        /* éšè—æ‰“å°ä¸“ç”¨å…ƒç´  */
        @media print {
            @page { size: A4 landscape; margin: 0.3cm; }
            .input-panel, .del-btn, .rule-btn, .top-nav-container a { display: none !important; }
            .rule-body.print-active { display: block !important; border: 1px solid #ffe58f; font-size: 10px; }
            .label-col { position: static !important; }
        }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <div class="watermark-overlay" id="watermark"></div>

    <div class="header-area">
        <p class="main-title">æ–°äººæ”¶å…¥ç›®æ ‡æµ‹ç®—çœ‹æ¿</p>
        <p class="sub-title">ç‰ˆæƒå½’PAç¦å°æ˜Š - 2026ç‰ˆ (ç§»åŠ¨è‡ªé€‚åº”ç‰ˆ)</p>
        <div style="width: 100%; display: flex; gap: 5px; margin-top: 5px;">
            <button onclick="clearAllData()" style="flex:1; background:var(--danger); border:none; color:#fff; border-radius:4px; padding:6px; font-size:12px;">æ¸…ç©º</button>
            <button onclick="exportExcel()" style="flex:1; background:#52c41a; border:none; color:#fff; border-radius:4px; padding:6px; font-size:12px;">å¯¼å‡º</button>
            <button onclick="smartPrint()" style="flex:1; background:var(--secondary); border:none; color:#fff; border-radius:4px; padding:6px; font-size:12px;">æ‰“å°</button>
        </div>
    </div>

    <div class="top-nav-container">
        <div class="btn-link rule-btn" onclick="toggleRule()">è®­ç»ƒæ´¥è´´è§„åˆ™åŸæ–‡</div>
        <a href="https://free-img.400040.xyz/4/2026/02/01/697f049d026fe.jpg" target="_blank" class="btn-link">é¦–æ¬¡é’»æ–¹æ¡ˆ</a>
        <a href="https://free-img.400040.xyz/4/2026/02/01/697f049ece8ab.jpg" target="_blank" class="btn-link">ä¸€æ¡Œå®´æ–¹æ¡ˆ</a>
    </div>

    <div class="rule-body" id="ruleBody">
        <div class="rule-columns">
            <div class="rule-col">
                <strong>ç¬¬ 1-12 æœŸè®­ç»ƒæ´¥è´´å‘æ”¾æ¡ä»¶</strong><br>
                1ï¼å½“æœˆå‚ä¼šç‡â‰¥75%ï¼› 2ï¼åŸ¹è®­è¾¾æ ‡ï¼šé£é¹°ã€æ–°é”ã€æ–°äººé›†è®­åˆæ ¼ï¼› 3ï¼ç¬¬4æœˆèµ·éœ€è½¬æ­£ã€‚
            </div>
            <div class="rule-col">
                <strong>ç¬¬ 13-18 æœŸè®­ç»ƒæ´¥è´´å‘æ”¾æ¡ä»¶</strong><br>
                ï¼ˆä¸€ï¼‰å½“æœˆå‚ä¼šç‡â‰¥75%ï¼›ï¼ˆäºŒï¼‰ç»§ç»­ç‡â‰¥80%ã€‚
            </div>
        </div>
    </div>

    <div class="input-panel">
        <div class="input-group"><label>äººå‘˜èŒçº§</label><select id="rank"><option value="P0">P0</option><option value="P1">P1</option><option value="P2">P2</option><option value="P3">P3</option><option value="P4">P4</option><option value="P5">P5</option><option value="P6">P6</option><option value="P7">P7</option><option value="P8">P8</option><option value="P9">P9</option></select></div>
        <div class="input-group"><label>æ ‡ç­¾</label><select id="tag" onchange="initPeriodOptions()"><option value="ä¼˜++">ä¼˜++</option><option value="ä¼˜+" selected>ä¼˜+</option><option value="FNA">FNA</option><option value="NA">NA</option></select></div>
        <div class="input-group"><label>æœŸæ•°</label><select id="period"></select></div>
        <div class="input-group"><label>ä¸ªäººFYC</label><input type="number" id="fyc" value="3000"></div>
        <div class="input-group"><label>æ˜¯å¦æœ‰å¢å‘˜ï¼Ÿ</label><select id="hasReferral" onchange="updateReferralInputs()"><option value="å¦">å¦</option><option value="æ˜¯">æ˜¯</option></select></div>
        
        <div id="referralInputs">
            <div class="ref-item"><label>æ¨èæœˆæ•°</label><select id="referralMonths"><option value="1-12">1-12æœˆ</option><option value="13-24">13-24æœˆ</option></select></div>
            <div class="ref-item"><label>æ¨èFYC</label><input type="number" id="referralFycInput" value="3000"></div>
            <div class="ref-item"><label>ç»§ç»­ç‡</label><select id="referralContinuation"><option value="80%ä»¥ä¸‹">80%ä»¥ä¸‹</option><option value="80%ä»¥ä¸Š" selected>80%åŠä»¥ä¸Š</option></select></div>
        </div>
        
        <div style="width: 100%; border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px;">
            <div style="display: flex; gap: 8px;">
                <input type="text" id="customName" placeholder="ç¦åˆ©é¡¹ç›®" style="flex:2;">
                <input type="number" id="customAmount" placeholder="ä»·å€¼" style="flex:1;">
                <button onclick="addCustomItem()" style="background:var(--secondary); color:#fff; border:none; border-radius:4px; padding:0 10px;">ï¼‹</button>
            </div>
            <div class="history-tags" id="historyTags"></div>
        </div>
        <button class="btn-calc" onclick="addScheme()">ç”Ÿæˆæ–¹æ¡ˆå¹¶å¯¹æ¯”</button>
    </div>

    <div class="table-wrapper">
        <table class="compare-table" id="resTable">
            <thead><tr class="header-row" id="hRow"><th class="label-col">æµ‹ç®—ç»´åº¦</th></tr></thead>
            <tbody id="bBody">
                <tr class="cat-row"><td class="label-col">åŸºæœ¬ä¿¡æ¯</td></tr>
                <tr data-k="rank"><td class="label-col">æµ‹ç®—èŒçº§</td></tr>
                <tr data-k="tag"><td class="label-col">æ ‡ç­¾/æœŸæ•°</td></tr>
                <tr class="cat-row"><td class="label-col">æ”¶ç›Šé¡¹ç›®</td></tr>
                <tr data-k="fyc"><td class="label-col">ä½£é‡‘ (FYC)</td></tr>
                <tr data-k="sales"><td class="label-col">é”€å”®æ´¥è´´</td></tr>
                <tr data-k="subsidy"><td class="label-col">è®­æ´¥ (å®å‘)</td></tr>
                <tr data-k="defer"><td class="label-col">è®­æ´¥é€’å»¶</td></tr>
                <tr data-k="ref_total"><td class="label-col">å¢å‘˜å¥–</td></tr>
                <tr class="cat-row"><td class="label-col">å…¶ä»–ç¦åˆ©</td></tr>
                <tr class="total-row" data-k="total" style="background:#fff9f9"><td class="label-col">é¢„è®¡æ€»åˆ©ç›Š</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    let currentCustomItems = [], schemes = [], welfareHistory = [], sIdx = 1;

    function saveData() { localStorage.setItem('fyc_m', JSON.stringify(schemes)); localStorage.setItem('fyc_idx_m', sIdx); localStorage.setItem('fyc_hist_m', JSON.stringify(welfareHistory)); }
    function loadData() {
        const saved = localStorage.getItem('fyc_m'), savedH = localStorage.getItem('fyc_hist_m');
        if (saved) { schemes = JSON.parse(saved); sIdx = parseInt(localStorage.getItem('fyc_idx_m')) || 1; rebuildTable(); }
        if (savedH) { welfareHistory = JSON.parse(savedH); renderHistoryTags(); }
    }
    function clearAllData() { if(confirm("æ¸…ç©ºè®°å½•ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    function rebuildTable() {
        const hRow = document.getElementById('hRow'), bBody = document.getElementById('bBody');
        while (hRow.cells.length > 1) hRow.deleteCell(1);
        Array.from(bBody.rows).forEach(row => { while (row.cells.length > 1) row.deleteCell(1); });
        Array.from(bBody.querySelectorAll('tr[data-custom-row]')).forEach(r => r.remove());

        const allNames = [...new Set(schemes.flatMap(s => s.customItems.map(i => i.name)))];
        const otherCat = Array.from(bBody.rows).find(r => r.innerText.includes('å…¶ä»–ç¦åˆ©'));
        allNames.forEach(name => {
            const tr = document.createElement('tr'); tr.setAttribute('data-custom-row', name);
            tr.innerHTML = `<td class="label-col">${name}</td>`; otherCat.after(tr);
        });

        schemes.forEach(s => {
            const th = document.createElement('th'); th.innerHTML = `æ–¹${s.displayIdx}<br><span onclick="removeCol('${s.id}')" style="font-size:10px; color:red;">ç§»é™¤</span>`;
            hRow.appendChild(th);
            Array.from(bBody.rows).forEach(row => {
                const k = row.getAttribute('data-k'), cName = row.getAttribute('data-custom-row'), td = document.createElement('td');
                td.className = s.id + '-c' + (k==='total'?' win-cell':'');
                if(k) td.innerHTML = s.dataMap[k] || 'â€”';
                else if(cName) { const match = s.customItems.find(i => i.name === cName); td.innerHTML = match ? `Â¥${match.amount}` : 'â€”'; }
                row.appendChild(td);
            });
        });
        updateWin();
    }

    function addCustomItem() {
        const name = document.getElementById('customName').value.trim(), amount = parseFloat(document.getElementById('customAmount').value);
        if (name && !isNaN(amount)) {
            currentCustomItems.push({ name, amount });
            if (!welfareHistory.includes(name)) welfareHistory.push(name);
            document.getElementById('customName').value = ''; document.getElementById('customAmount').value = '';
            renderHistoryTags();
            alert("ç¦åˆ©é¡¹ç›®æš‚å­˜æˆåŠŸï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆæ–¹æ¡ˆå³å¯çœ‹åˆ°ï¼");
        }
    }

    function renderHistoryTags() {
        document.getElementById('historyTags').innerHTML = welfareHistory.map(name => `<div class="history-tag" onclick="document.getElementById('customName').value='${name}'">${name}</div>`).join('');
    }

    const salesMatrix = { 'P0':[0,0,0,0,0,0,0,0],'P1':[0,0,0,0,0,0,0,0],'P2':[0,0.04,0.09,0.13,0.13,0.13,0.13,0.13],'P3':[0,0.06,0.11,0.15,0.18,0.18,0.18,0.18],'P4':[0,0.06,0.25,0.30,0.35,0.35,0.35,0.35],'P5':[0,0.06,0.27,0.32,0.37,0.42,0.42,0.42],'P6':[0,0.06,0.30,0.34,0.40,0.45,0.47,0.47],'P7':[0,0.06,0.32,0.37,0.42,0.50,0.52,0.55],'P8':[0,0.06,0.32,0.37,0.45,0.52,0.55,0.57],'P9':[0,0.06,0.32,0.37,0.45,0.55,0.57,0.60] };
    function getSubsidy(f, t, p) { let val=0, def=0; if(t==='ä¼˜++') { let i=[3000,6000,10000,20000,30000,60000].findIndex(v=>f<v); i=i===-1?5:Math.max(0,i-1); if(f>=3000){ val=(p==='13-18')?[1800,5400,8000,16000,20000,30000][i]:[3600,6000,10000,20000,30000,60000][i]; def=f>=10000?[0,0,0.3,0.4,0.5,0.6][i]:0; } } else { let i=[600,1500,3000,6000,10000,20000,30000].findIndex(v=>f<v); i=i===-1?6:Math.max(0,i-1); if(p==='1-3') val=t==='ä¼˜+'?[1000,2400,3600,4400,5400,8500,11500][i]:(t==='FNA'?[1000,1800,2400,3000,3800,6000,8000][i]:[600,1100,1400,1400,1400,1400,1400][i]); else if(p==='4-12'&&t!=='NA') val=t==='ä¼˜+'?[1000,1600,2700,4400,5400,8500,11500][i]:[1000,1300,1800,2400,3300,5500,7500][i]; else if(p==='13-18'&&t==='ä¼˜+') val=[0,0,1400,2700,3600,5800,8100][i]; } return { cash: val*(1-def), defer: val*def }; }

    function addScheme() {
        const f = parseFloat(document.getElementById('fyc').value)||0, r = document.getElementById('rank').value, t = document.getElementById('tag').value, p = document.getElementById('period').value;
        const rates = salesMatrix[r]||salesMatrix['P0'], rate = f<1500?rates[0]:f<3000?rates[1]:f<6000?rates[2]:f<10000?rates[3]:f<20000?rates[4]:f<30000?rates[5]:f<60000?rates[6]:rates[7];
        const sales = f * rate, sub = getSubsidy(f, t, p);
        let ref = 0; if(document.getElementById('hasReferral').value==='æ˜¯'){ 
            const rf=parseFloat(document.getElementById('referralFycInput').value)||0, rm=document.getElementById('referralMonths').value, rc=document.getElementById('referralContinuation').value;
            const c1=(rm==='1-12')?(rf<1500?0.05:rf<3000?0.15:rf<6000?0.21:0.24):(rf>=6000?0.1:rf>=3000?0.08:0);
            ref=rf*c1*((rm==='13-24'&&rc==='80%ä»¥ä¸‹')?0:1);
        }
        const total = f+sales+sub.cash+sub.defer+ref+currentCustomItems.reduce((s,i)=>s+i.amount, 0);
        const dataMap = { rank:r, tag:`${t}(${p})`, fyc:`Â¥${f.toLocaleString()}`, sales:`Â¥${sales.toLocaleString()}`, subsidy:`Â¥${sub.cash.toLocaleString()}`, defer:`Â¥${sub.defer.toLocaleString()}`, ref_total:`Â¥${ref.toLocaleString()}`, total:`<div class="crown-icon">ğŸ‘‘</div><span class="total-val">Â¥${total.toLocaleString()}</span>` };
        schemes.push({ id:'s'+Date.now(), total, displayIdx: sIdx++, customItems: [...currentCustomItems], dataMap });
        saveData(); rebuildTable(); currentCustomItems = [];
    }

    function removeCol(id) { schemes = schemes.filter(x => x.id !== id); saveData(); rebuildTable(); }
    function updateWin() { if(!schemes.length) return; const max = Math.max(...schemes.map(s => s.total)); schemes.forEach(s => { const el = document.querySelector('.' + s.id + '-c.win-cell'); if (el) el.classList.toggle('is-winner', s.total === max && max > 0); }); }
    function toggleRule() { const b = document.getElementById('ruleBody'); b.style.display = (b.style.display==='block'?'none':'block'); b.classList.toggle('print-active'); }
    function initPeriodOptions() { const t = document.getElementById('tag').value, p = document.getElementById('period'); p.innerHTML = ''; let opts = t==='ä¼˜++' ? [['4-12æœŸ','4-12'],['13-18æœŸ','13-18']] : [['1-3æœŸ','1-3'],['4-12æœŸ','4-12'],['13-18æœŸ','13-18']]; opts.forEach(o => p.add(new Option(o[0], o[1]))); }
    function updateReferralInputs() { document.getElementById('referralInputs').style.display = (document.getElementById('hasReferral').value==='æ˜¯'?'flex':'none'); }
    function smartPrint() { const t = document.getElementById('resTable'); document.body.style.zoom = (t.offsetWidth > 1000) ? (1000 / t.offsetWidth).toFixed(2) : 1; window.print(); setTimeout(()=>document.body.style.zoom=1,500); }
    function exportExcel() { const t = document.getElementById('resTable').cloneNode(true); t.querySelectorAll('.del-btn, .crown-icon').forEach(e => e.remove()); XLSX.writeFile(XLSX.utils.table_to_book(t), 'æ–°äººæŠ¥å‘Š.xlsx'); }
    window.onload = () => { initPeriodOptions(); loadData(); const c = document.createElement('canvas'); c.width=200; c.height=150; const ctx = c.getContext('2d'); ctx.rotate(-0.4); ctx.font='14px Arial'; ctx.fillStyle='rgba(0,0,0,0.1)'; ctx.fillText('PAç¦å°æ˜Š', 20, 80); document.getElementById('watermark').style.backgroundImage = `url(${c.toDataURL()})`; }
</script>
</body>
</html>
